@model IEnumerable<Gerenciador_de_Produtos.Models.ItemERP>

@{
    ViewData["Title"] = "Itens ERP";
}

<h1 class="mb-4">@ViewData["Title"]</h1>

<div class="mb-3 d-flex align-items-center">
    <a asp-action="Create" class="btn btn-primary">Novo ItemERP</a>
    <input id="searchInput" type="text" class="form-control ms-3" placeholder="Buscar ERP ou Descrição..." style="max-width:300px;" />
</div>

<div class="accordion" id="itensAccordion">
    @foreach (var item in Model)
    {
        var headingId = $"headingERP{item.Id}";
        var collapseId = $"collapseERP{item.Id}";
        <div class="accordion-item mb-3" data-filter="@(item.ERP + " " + item.Descricao).ToLower()">
            <h2 class="accordion-header" id="@headingId">
                <button class="accordion-button collapsed d-flex justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                    <div>
                        <strong>@item.ERP</strong> (@item.Id)
                        @if (!string.IsNullOrWhiteSpace(item.Descricao))
                        {
                            <small class="text-muted ms-2">@item.Descricao</small>
                        }
                    </div>
                    <div>
                        <span class="badge bg-secondary me-2">@item.Status</span>
                    </div>
                </button>
            </h2>
            <div id="@collapseId" class="accordion-collapse collapse" aria-labelledby="@headingId" data-bs-parent="#itensAccordion">
                <div class="accordion-body bg-light p-4">
                    <div class="row mb-3">
                        <div class="col-md-4"><strong>Tipo:</strong> @item.TipoItem</div>
                        <div class="col-md-4"><strong>Original:</strong> @item.ItemERPIdOriginal</div>
                        <div class="col-md-4"><strong>Revisão:</strong> @item.Revisao</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4"><strong>Data Criação:</strong> @(item.DataCriacao?.ToString("dd/MM/yyyy"))</div>
                        <div class="col-md-4"><strong>Acabamento:</strong> @item.Acabamento</div>
                        <div class="col-md-4"><strong>Chapa Aberta:</strong> @item.ChapaAberta</div>
                    </div>
                    <div class="bg-white p-3 rounded mb-4">
                        <h6 class="mb-2">Tags Vinculadas</h6>
                        @if (item.Tags != null && item.Tags.Any())
                        {
                            <ul class="list-group">
                                @foreach (var tag in item.Tags)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        @tag.Nome
                                        <div>
                                            <a asp-controller="Tags" asp-action="Edit" asp-route-id="@tag.Id" class="btn btn-sm btn-outline-secondary">Editar</a>
                                            <a asp-controller="Tags" asp-action="Details" asp-route-id="@tag.Id" class="btn btn-sm btn-outline-info ms-1">Detalhes</a>
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Nenhuma tag vinculada</p>
                        }
                    </div>
                    <div class="bg-white p-3 rounded">
                        <h6 class="mb-2">Agrupadores Vinculados</h6>
                        @if (item.AgrupadorItensERP.Any())
                        {
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Agrupador</th>
                                        <th>Comprimento</th>
                                        <th>Altura</th>
                                        <th>Profundidade</th>
                                        <th>Quantidade</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var vinculo in item.AgrupadorItensERP)
                                    {
                                        <tr>
                                            <td>@vinculo.Agrupador.Nome</td>
                                            <td>@vinculo.Comprimento</td>
                                            <td>@vinculo.Altura</td>
                                            <td>@vinculo.Profundidade</td>
                                            <td>@vinculo.Quantidade</td>
                                            <td>
                                                <span class="badge @(vinculo.Status ? "bg-success" : "bg-secondary")">
                                                    @(vinculo.Status ? "Ativo" : "Inativo")
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Sem agrupadores vinculados</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            document.querySelectorAll('#itensAccordion .accordion-item').forEach(function(item) {
                const data = item.getAttribute('data-filter');
                item.style.display = data.includes(filter) ? '' : 'none';
            });
        });
    </script>
}
