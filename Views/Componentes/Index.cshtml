@model IEnumerable<Gerenciador_de_Produtos.Models.Componente>

@{
    ViewData["Title"] = "Componentes";
}

<!-- Estilos de rotação do ícone (mova para site.css se preferir) -->
<style>
    .toggle-icon {
        transition: transform 0.3s ease;
    }

    .toggle-collapsed .toggle-icon {
        transform: rotate(-90deg);
    }
</style>

<div class="mb-4">
    <h3 class="fw-bold mb-3">@ViewData["Title"]</h3>
    <div class="row g-2">
        <div class="col-auto">
            <a asp-action="Create" class="btn btn-primary rounded-pill py-0 px-3">
                <i class="bi bi-plus-lg me-1"></i>Criar Novo
            </a>
        </div>
        <div class="col">
            <input id="searchInput" class="form-control" placeholder="Buscar Nome, Descrição ou Nível..." />
        </div>
    </div>
</div>

<div class="accordion" id="componentesAccordion">
    @foreach (var comp in Model)
    {
        var headingId = $"headingComp{comp.Id}";
        var collapseId = $"collapseComp{comp.Id}";
        <div class="accordion-item mb-3" data-search="@comp.Nome @comp.Descricao @(comp.Nivel?.ToString() ?? "")">
            <h2 class="accordion-header" id="@headingId">
                <button class="accordion-button collapsed d-flex justify-content-between"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#@collapseId"
                        aria-expanded="false"
                        aria-controls="@collapseId">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chevron-down toggle-icon me-2"></i>
                        <strong>@comp.Nome</strong>
                        <small class="text-muted ms-2">(@comp.Descricao)</small>
                    </div>
                    <span class="badge bg-secondary">Nível @comp.Nivel</span>
                </button>
            </h2>
            <div id="@collapseId"
                 class="accordion-collapse collapse"
                 aria-labelledby="@headingId"
                 data-bs-parent="#componentesAccordion">
                <div class="accordion-body bg-light p-4">
                    <!-- Seção de Variáveis -->
                    <div class="mb-4">
                        <h6 class="mb-2">Variáveis</h6>
                        <a asp-controller="VariaveisComponentes"
                           asp-action="Create"
                           asp-route-componenteId="@comp.Id"
                           class="btn btn-sm btn-outline-success rounded-pill py-0 px-2 mb-2">
                            <i class="bi bi-plus-lg me-1"></i>Adicionar Variável
                        </a>
                        @if (comp.VariaveisComponentes?.Any() == true)
                        {
                            <ul class="list-group">
                                @foreach (var v in comp.VariaveisComponentes)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            <strong>@v.Nome</strong>
                                            <small class="text-muted ms-2">(@v.Tipo)</small>
                                        </span>
                                        <div>
                                            <a asp-controller="VariaveisComponentes"
                                               asp-action="Edit"
                                               asp-route-id="@v.Id"
                                               class="btn btn-sm btn-outline-secondary me-1">
                                                Editar
                                            </a>
                                            <a asp-controller="VariaveisComponentes"
                                               asp-action="Details"
                                               asp-route-id="@v.Id"
                                               class="btn btn-sm btn-outline-info">
                                                Detalhes
                                            </a>
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Nenhuma variável cadastrada.</p>
                        }
                    </div>

                    <!-- Seção de Agrupadores -->
                    <div>
                        <h6 class="mb-2">Agrupadores</h6>
                        <a asp-controller="AgrupadoresComponentes"
                           asp-action="Create"
                           asp-route-componenteId="@comp.Id"
                           class="btn btn-sm btn-outline-warning rounded-pill py-0 px-2 mb-2">
                            <i class="bi bi-plus-lg me-1"></i>Adicionar Agrupador
                        </a>
                        @if (comp.AgrupadorComponentes?.Any() == true)
                        {
                            <ul class="list-group">
                                @foreach (var ap in comp.AgrupadorComponentes)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        @ap.Agrupador.Nome
                                        <div>
                                            <a asp-controller="AgrupadoresComponentes"
                                               asp-action="Edit"
                                               asp-route-id="@ap.Id"
                                               class="btn btn-sm btn-outline-secondary me-1">
                                                Editar
                                            </a>
                                            <a asp-controller="AgrupadoresComponentes"
                                               asp-action="Details"
                                               asp-route-id="@ap.Id"
                                               class="btn btn-sm btn-outline-info">
                                                Detalhes
                                            </a>
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Nenhum agrupador vinculado.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // filtro em tempo real
        document.getElementById('searchInput').addEventListener('input', function() {
            const filtro = this.value.toLowerCase();
            document.querySelectorAll('[data-search]').forEach(card => {
                card.style.display = card.getAttribute('data-search')
                                             .toLowerCase()
                                             .includes(filtro)
                                 ? '' : 'none';
            });
        });
        // mantém toggles fechados e anima ícone
        document.querySelectorAll('.accordion-button').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.querySelector('.toggle-icon').classList.toggle('toggle-collapsed');
            });
        });
    </script>
}
